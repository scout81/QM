<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>HKG81 QM Dashboard</title>
    <link rel="stylesheet" media="screen" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker3.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>

    <script src="https://code.jquery.com/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="https://api.trello.com/1/client.js?key=8a42b4468e08ca9f165c88d1327add61"></script>
    <script src="js/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="js/Autolinker.min.js" type="text/javascript"></script>
    <script src="js/main.js" type="text/javascript"></script>

    <script type="text/javascript">
        var cards = [];
        var loadCards = function() {
            trelloGet('/boards/'+Board+'/cards?checklists=all',
                showCards,
                function() { 
					$('#loader').remove();
					failAlert("load cards fail"); 
				}
            );
        };

        var showCards = function(data) {
            $('#loader').remove();
            $('.dashboard').removeClass('hidden');

            cards = data;
            
            var borrowed_count = 0;
            var overdue_count = 0;
            var repair_count = 0;
            var drying_count = 0;
            var damaged_count = 0;
            var broken_count = 0;
            
            var pending_count = 0;
            var overdueRequest_count = 0;
            var active_count = 0;
            
            
            // Find out overdue items
            var OverdueCardUrls = [];
            $.each(cards, function(index, card) {
                var dueDt = null;
                if (card.due != null)
                    dueDt = new Date(card.due.substring(0,4), card.due.substring(5,7)-1, card.due.substring(8,10));

                if ( hasLabel(card, Label.borrowRec) || hasLabel(card, Label.repairRec) ) {
                    var dueDt = null;
                    if (card.due != null)
                        dueDt = new Date(card.due.substring(0,4), card.due.substring(5,7)-1, card.due.substring(8,10));

                    // Check card status
                    var pending = (card.idList == List.pending);
                    var completed = (card.idList == List.completed);
                    var overdueRequest = (dueDt != null && dueDt < new Date() && card.badges.checkItemsChecked < card.badges.checkItems);
                    var active = (!pending && !completed && !overdueRequest);
                    
                    if (overdueRequest) {
                        if (card.checklists.length > 0) {
                            for (var i = 0; i < card.checklists[0].checkItems.length; i++) {
                                if (card.checklists[0].checkItems[i].state == 'incomplete') {
                                    OverdueCardUrls.push(card.checklists[0].checkItems[i].name);
                                }
                            }
                        }
                    }
                    
                    if (pending)
                        pending_count++;
                    if (overdueRequest)
                        overdueRequest_count++;
                    if (active)
                        active_count++;
                }
            });
            
            // Loop each cards
            $.each(cards, function(index, card) {
                if (!hasLabel(card, Label.borrowRec) && !hasLabel(card, Label.repairRec)) {
                    // Check card status
                    var borrowed = isBorrowed(card);
                    var overdue = ($.inArray(card.url, OverdueCardUrls) > -1);
                    var repair = (card.idList == List.repair);
                    var drying = (card.idList == List.drying);
                    var damaged = hasLabel(card, Label.damaged);
                    var broken = hasLabel(card, Label.broken);
                    
                    if (borrowed)
                        borrowed_count++;
                    if (overdue)
                        overdue_count++;
                    if (repair)
                        repair_count++;
                    if (drying)
                        drying_count++;
                    if (damaged)
                        damaged_count++;
                    if (broken)
                        broken_count++;
                }
            });
            
            $('#borrowed').html(borrowed_count);
            $('#overdue').html(overdue_count);
            $('#repair').html(repair_count);
            $('#drying').html(drying_count);
            $('#damaged').html(damaged_count);
            $('#broken').html(broken_count);
            
            $('#pending').html(pending_count);
            $('#overdueRequest').html(overdueRequest_count);
            $('#activeRequest').html(active_count);
        }

        $(function(){
            trelloAuthorize(loadCards);
			
            $('.dashboard-widget').on('click', function() {
                window.location.href = $(this).data('url');
            });
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">HKG81 QM</a>
            </div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="index.html">首頁</a></li>
                <li><a href="request.html">借用申請</a></li>
                <li><a href="list.html">物資清單</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">

        <div class="alert hidden" role="alert" id="alert-box">
            <span id="alert-msg"></span>
        </div>

        <div id="loader" style="text-align:center;">
            <img src="img/loading.gif"/>
        </div>
        <div class="dashboard row hidden">
            <div class="col-xs-12 col-sm-8 col-md-6">
                <div class="dashboard-widget bg-request" data-url="request.html">
                    <div class="row">
                        <div class="col-xs-3">
                            <div class="dashboard-widget-icon">
                                <div>
                                    <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
                                </div>
                                <div class="dashboard-widget-title">
                                    借用申請情況
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="dashboard-widget-icon dashboard-widget-request pull-right" >
                                <div id="overdueRequest"></div>
                                <div class="dashboard-widget-title">逾時未還</div>
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="dashboard-widget-icon dashboard-widget-request pull-right" >
                                <div id="activeRequest"></div>
                                <div class="dashboard-widget-title">進行中</div>
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="dashboard-widget-icon dashboard-widget-request pull-right" >
                                <div id="pending"></div>
                                <div class="dashboard-widget-title">待處理</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xs-6 col-sm-4 col-md-3">
                <div class="dashboard-widget bg-borrowed" data-url="list.html?s=borrowed">
                    <div class="dashboard-widget-icon">
                        <div>
                            <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
                        </div>
                        <div class="dashboard-widget-title">借出</div>
                    </div>
                    <span id="borrowed" class="dashboard-widget-counter pull-right"></span>
                </div>
            </div>
            <div class="col-xs-6 col-sm-4 col-md-3">
                <div class="dashboard-widget bg-late" data-url="list.html?s=late">
                    <div class="dashboard-widget-icon">
                        <div>
                            <span class="glyphicon glyphicon-time" aria-hidden="true"></span>
                        </div>
                        <div class="dashboard-widget-title">逾時未還</div>
                    </div>
                    <span id="overdue" class="dashboard-widget-counter pull-right"></span>
                </div>
            </div>
            <div class="col-xs-6 col-sm-4 col-md-3 col-md-offset-6">
                <div class="dashboard-widget bg-repair" data-url="list.html?s=repair">
                    <div class="dashboard-widget-icon">
                        <div>
                            <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
                        </div>   
                        <div class="dashboard-widget-title">維修中</div>
                    </div>
                    <span id="repair" class="dashboard-widget-counter pull-right"></span>
                </div>
            </div>
            <div class="col-xs-6 col-sm-4 col-md-3">
                <div class="dashboard-widget bg-drying" data-url="list.html?s=drying">
                    <div class="dashboard-widget-icon">
                        <div>
                            <span class="glyphicon glyphicon-tint" aria-hidden="true"></span>
                        </div>
                        <div class="dashboard-widget-title">晾曬中</div>
                    </div>
                    <span id="drying" class="dashboard-widget-counter pull-right"></span>
                </div>
            </div>
        </div>
        <div style="height: 100px">&nbsp;</div>
    </div>

</body>
</html>
